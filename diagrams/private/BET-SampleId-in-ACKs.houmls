<?xml version="1.0" encoding="UTF-8"?><diagram program="houmls" version="0.0.1">
    <zoom_level>10</zoom_level>
    <help_text/>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>410</x>
            <y>460</y>
            <w>240</w>
            <h>250</h>
        </coordinates>
        <panel_attributes>  Inbound ACKs

valign=top
halign=left
fontsize=28</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>50</x>
            <y>1840</y>
            <w>240</w>
            <h>250</h>
        </coordinates>
        <panel_attributes>  Inbound ACKs

valign=top
halign=left
fontsize=28</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>1100</x>
            <y>1110</y>
            <w>580</w>
            <h>560</h>
        </coordinates>
        <panel_attributes>* Related classes
fontsize=25
valign=top
halign=left</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>0</x>
            <y>2110</y>
            <w>850</w>
            <h>670</h>
        </coordinates>
        <panel_attributes>* Involved database tables















valign=top
halign=left

bg=gray
fontsize=25
</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>880</x>
            <y>2110</y>
            <w>640</w>
            <h>670</h>
        </coordinates>
        <panel_attributes>* Related classes
fontsize=25
valign=top
halign=left</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>0</x>
            <y>1110</y>
            <w>1080</w>
            <h>560</h>
        </coordinates>
        <panel_attributes>* Involved database tables
















valign=top
halign=left

bg=gray
fontsize=25
</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>1770</x>
            <y>1490</y>
            <w>120</w>
            <h>60</h>
        </coordinates>
        <panel_attributes>hca.chcaWSModule
--
--
--
fontsize=10
bg=orange
layer=1
transparency=0</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>1970</x>
            <y>1490</y>
            <w>170</w>
            <h>60</h>
        </coordinates>
        <panel_attributes>hca.chcaMainEntrance
--
--
InMessage()
--
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>1890</x>
            <y>1520</y>
            <w>80</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-</panel_attributes>
        <additional_attributes>80;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>1790</x>
            <y>1300</y>
            <w>390</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>ClassMethod GetMessage(...)
{
   ##class(hca.chcaMainEntrance).InMessage(...)
   [...]

      ##class(hca.mhl.cMessageHandlerManager)
           .UpdateReceiversINinOUT(
               intReceiversOUT, intReceiversIN)

					

bg=yellow
fontsize=12</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>1830</x>
            <y>1440</y>
            <w>0</w>
            <h>50</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;0;0;50</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>1970</x>
            <y>1570</y>
            <w>170</w>
            <h>60</h>
        </coordinates>
        <panel_attributes>hca.mhl.cMessageHandlerManager
--
--
UpdateReceiversINinOUT(..)
--
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>1830</x>
            <y>1550</y>
            <w>140</w>
            <h>50</h>
        </coordinates>
        <panel_attributes>lt=&lt;-</panel_attributes>
        <additional_attributes>140;50;0;50;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>2230</x>
            <y>1490</y>
            <w>190</w>
            <h>60</h>
        </coordinates>
        <panel_attributes>hca.mhl.chcaMessageReaderDaemon
--
--
MainReader()
Reader()
--
fontsize=10
bg=orange</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>2140</x>
            <y>1520</y>
            <w>90</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=.
&lt;&lt;asynch&gt;&gt;</panel_attributes>
        <additional_attributes>90;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>50</x>
            <y>840</y>
            <w>240</w>
            <h>250</h>
        </coordinates>
        <panel_attributes>  Outbound ACKs

valign=top
halign=left
fontsize=28
</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>180</x>
            <y>920</y>
            <w>70</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>.VC
halign=center
fontsize=18
bg=green</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>80</x>
            <y>1020</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
ACK       
fontsize=18</panel_attributes>
        <additional_attributes>0;0;100;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>80</x>
            <y>950</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
Message              
fontsize=18</panel_attributes>
        <additional_attributes>100;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>90</x>
            <y>1920</y>
            <w>70</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>.VC
halign=center
fontsize=18
bg=green</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>160</x>
            <y>1950</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
Message           </panel_attributes>
        <additional_attributes>100;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>0</x>
            <y>840</y>
            <w>40</w>
            <h>40</h>
        </coordinates>
        <panel_attributes>A
fontsize=30</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>0</x>
            <y>1840</y>
            <w>40</w>
            <h>40</h>
        </coordinates>
        <panel_attributes>.B
fontsize=30</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>160</x>
            <y>2020</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
ACK               
fontsize=18</panel_attributes>
        <additional_attributes>0;0;100;0</additional_attributes>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>2470</x>
            <y>1110</y>
            <w>890</w>
            <h>850</h>
        </coordinates>
        <panel_attributes>
======================================================================
M ==&gt; VC ==&gt; ACK
======================================================================

The column thcaMessageReceiversOUT.MessageReceiversIN relates the outbound messages that are generated by an inbound one.

(1) With the OC ACK's, this column is not setted. Solution: 

	##class(Oc.AckManager).ResponseACK()
				
			#Dim outReceiversID As %Integer = ##class(cMessageHandlerManager).SaveMsgOutReceivers(outQueueID, msgObjId, ##class(Consts.MessageOpenedStatus).#MessageProcessed, channel, trace, msgObjOUT.TS.TSUser, .status)
			Do ##class(InternalExceptionBuilder).CheckStatusAndThrowGeneralException(status, ##class(Consts.InternalErrors).#SystemErrors)
			
			/// NEW! NEW! NEW! NEW! NEW!
			/// NEW! NEW! NEW! NEW! NEW!
			/// NEW! NEW! NEW! NEW! NEW!
			// (pintReceiversOUT As %Integer, pintReceiversIN As %Integer, pstrTraceMode As %String, pobjTraceInfo As dt.hcaTraceInfo)
			Set status = ##class(hca.mhl.cMessageHandlerManager).UpdateReceiversINinOUT(outReceiversID, trace.MessageReceiversID, "QLI", trace)
			Do ##class(InternalExceptionBuilder).CheckStatusAndThrowGeneralException(status, ##class(Consts.InternalErrors).#SystemErrors)
			/// NEW! NEW! NEW! NEW! NEW!
			/// NEW! NEW! NEW! NEW! NEW!
			/// NEW! NEW! NEW! NEW! NEW!
			
			#Dim restResponse As %String = ..SendACKMessage(msgObjOUT, workflow.AckId)



(2) Use the point in code in witch the relationship is made, to relate the *SampleId*:

	##class(hca.mhl.cMessageHandlerManager).UpdateReceiversINinOUT()

			Set objReceiversID.MessageReceiversIN = pintReceiversIN

			// NEW! NEW! NEW! NEW! NEW! 
			#Dim receiversIn As User.thcaMessageReceiversIN = ##class(User.thcaMessageReceiversIN).%OpenId(pintReceiversIN)
			if (receiversIn'="")
			{
				if (receiversIn.SampleID '= "")
				{
					Set objReceiversID.SampleID = receiversIn.SampleID
				}
			}
			// NEW! NEW! NEW! NEW! NEW! 


	Buuuut... wait a moment! works for HL7 and OC, buuuuuut for WS the SampleId is not found....
	This is because the hca.chcaWSModule/hca.chcaMainEntrance and the "hca.mhl.chcaMessageReaderDaemon" runs on different Threads/Jobs!!
	Demonstrated: placing a "H 3" in the "##class(hca.mhl.cMessageHandlerManager).UpdateReceiversINinOUT()", founds all the SampleId's

(3) To make WS ACKs working, we need, at the update that does the WS IMP Layer (e.j. ##class(hca.WS.UpathCloud.chcaUpathCloudImp).HandleAsyncAction(): #Dim result As %Status = ..MessageHandlerManager.SaveObjectIn(...))
	add the update


	##class(hca.mhl.cMessageHandlerManager).SaveObjectIn()


		// NEW! NEW! NEW! NEW! NEW! 
		// NEW! NEW! NEW! NEW! NEW! 
		// NEW! NEW! NEW! NEW! NEW! 
		&amp;sql(UPDATE SQLUser.thcaMessageReceiversOUT SET SampleID=:sampleId WHERE MessageReceiversIN=:pintMsgID)
		// NEW! NEW! NEW! NEW! NEW! 
		// NEW! NEW! NEW! NEW! NEW! 
		// NEW! NEW! NEW! NEW! NEW! 
		
		(remember to filter by ConnectionType/MessageType?)


(4) OK, but now there are some pending messages... ulala, so the HandleAsyncAction messages are working, but now remains the HandleSyncAction ones!!

		UPATH CLOUD/sendScannedSlideImageLabelId
		UPATH/sendScannedSlideImageLabelId
		UPATH CLOUD/sendScannedSlideImageLabelId
		UPATH/sendScannedSlideImageLabelId
		UPATH CLOUD/sendScannedSlideImageLabelId



	BIG PROBLEM!:
	
		In "hca.WS.chcaHostRouter" we need to update the SampleID of the OUT from the IN one, bit the previous query: but to obtain
		the SampleID, we need the msgLIS, but the "SyncAction"'s we don't have msgLIS!!!
	
	NONONO, NO PROBLEM:
	
	    #Dim isSyncAction As %Boolean = ..HostImport.IsSyncAction(root)
	    
		If (isSyncAction)
		{
			// en aquest punt, la relaci√≥ IN&lt;=&gt;OUT esta be, pero el IN.SampleId esta a NULL, encara no s'ha rellenat.
			//h 10

			#Dim syncStatus As %Status = ..HostImport.HandleSyncAction(root, structured, traceInfo)

			// NEW! NEW! NEW! NEW! NEW! 
			// NEW! NEW! NEW! NEW! NEW! 
			// NEW! NEW! NEW! NEW! NEW! 
			&amp;sql(UPDATE SQLUser.thcaMessageReceiversOUT SET SampleID=(SELECT SampleID FROM SQLUser.thcaMessageReceiversIN WHERE ID=:receiversID) WHERE MessageReceiversIN=:receiversID)
			// NEW! NEW! NEW! NEW! NEW! 
			// NEW! NEW! NEW! NEW! NEW! 
			// NEW! NEW! NEW! NEW! NEW! 

			Return syncStatus
		}

		#Dim msgLIS As msg.LIS = ..HostImport.BuildMsgLisForAsyncAction(root, structured, traceInfo)
		If ($Get(msgLIS) = $$$NULLOREF)
		{
			Return $$$OK
		}


======================================================================
VC ==&gt; M
VC &lt;== ACK
======================================================================


		User.thcaACK - MessageReceiversOUT references the OUT messages that this ACK is confirming

			##class(hca.chcaACK).InsertACKData() - Crea un nuevo registro en thcaACK
			##class(hca.chcaACK).UpdateInfoACKReceived() - Actualiza el estado de AppACKReceived en la tabla thcaMessageReceiversOUT


(1) at the point in which the "User.thcaACK" is updated with the received ACK, add the logic to get the "SampleID" from the OUT table, 
    in order to set in the IN table:

	##class(hca.chcaACK).UpdateInfoACKReceived()


		Set objSQL = ##class(%SQL.Statement).%ExecDirect(, strSQL, pobjmsgLIS.Header.OriMessageControlID, pobjTraceInfo.HostID)
		If (objSQL.%Next())
		{
			
			// NEW! NEW! NEW! NEW! NEW!
			Set messageReceiversOut = ##class(User.thcaMessageReceiversOUT).%OpenId(objSQL.MessageReceiversOUT)
			#Dim sampleId As %String = messageReceiversOut.SampleID
			// NEW! NEW! NEW! NEW! NEW!
			
		
			[...]


		//Update ErrorMessage for the ACK message received
		Set objMessageReceiver = ##class(User.thcaMessageReceiversIN).%OpenId(pobjTraceInfo.MessageReceiversID, 4, .intResult)
		
		// NEW !NEW !NEW !NEW !
		Set objMessageReceiver.SampleID = sampleId
		Do objMessageReceiver.%Save()
		// NEW !NEW !NEW !NEW !
		
		If ($System.Status.IsError(intResult) || (objMessageReceiver = ""))


(2) this works for the HL7/OC ACKs, but the WS one's are missed!




======================================================================
MORE WORK:
======================================================================

	Verify for both directions:
		- the behaviour for the message rejections (NACKS) in HL7/OC/WS!
		- the VantageWS's ApplicationACK (+NACKs)
		- the LIS ACK's with AC+AA, AC+AE, ...

		
fontsize=8
halign=left
</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>20</x>
            <y>1290</y>
            <w>140</w>
            <h>230</h>
        </coordinates>
        <panel_attributes>*thcaMessageReceiversIN
--
AppACKSend
ComACKSend
CreationDate
LstID
MessageControlID
MessageType
Opened
Priority
ProcessNum
SampleID
Sender
SenderID
WSComAnswer
rMessageObject
rMessageQueue
--

transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>240</x>
            <y>1180</y>
            <w>160</w>
            <h>170</h>
        </coordinates>
        <panel_attributes>*thcaMessageObjectIN
--
ID
Sender
SenderID
LISObject_Block_ActionCode
LISObject_Block_Assigned
LISObject_Block_Autogenerated
LISObject_Block_BlockID
LISObject_Block_Comments
LISObject_Block_ExtBlockID
[...]
--
transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>240</x>
            <y>1430</y>
            <w>160</w>
            <h>210</h>
        </coordinates>
        <panel_attributes>*thcaMessageQueueIN
--
ID
AllowReopen
ConnectionID
ConnectionType
CreationDate
MessageBody
MessageBodyText
MessageInfo
Sender
SenderID
ShortMessageBodyText
TS_TSDateTime
TS_TSUser
--
transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>160</x>
            <y>1320</y>
            <w>80</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=*
</panel_attributes>
        <additional_attributes>80;0;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>160</x>
            <y>1480</y>
            <w>80</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=*</panel_attributes>
        <additional_attributes>80;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>680</x>
            <y>1300</y>
            <w>150</w>
            <h>230</h>
        </coordinates>
        <panel_attributes>*thcaMessageReceiversOUT
--
ID
AppACKReceived
ComACKReceived
CreationDate
ErrorProcessing
MessageReceiversIN
MessageType
Opened
Priority
SampleID
Sender
SenderID
rMessageObject
rMessageQueue
TS_TSDateTime
TS_TSUser
--
transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>900</x>
            <y>1130</y>
            <w>160</w>
            <h>320</h>
        </coordinates>
        <panel_attributes>*thcaMessageObjectOUT
--
ID
CanceledRetry
ChannelID
ConnectionID
ConnectionType
CreationDate
MaxRetriesReached
MessageInfo
NumberOfRetries
PrintedMarks
Priority
SampleID
SendMoment
Sender
SenderID
TimeLastSend
LISObject_Block_ActionCode
LISObject_Block_Assigned
LISObject_Block_Autogenerated
LISObject_Block_BlockID
LISObject_Block_Comments
LISObject_Block_ExtBlockID
[...]
--
transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>900</x>
            <y>1470</y>
            <w>140</w>
            <h>150</h>
        </coordinates>
        <panel_attributes>*thcaMessageQueueOUT
--
ID
CreationDate
MessageBody
MessageBodyText
Sender
SenderID
ShortMessageBodyText
TS_TSDateTime
TS_TSUser
--
transparency=0
fontsize=10</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>830</x>
            <y>1360</y>
            <w>70</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=*
</panel_attributes>
        <additional_attributes>70;0;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>830</x>
            <y>1510</y>
            <w>70</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=*
</panel_attributes>
        <additional_attributes>70;0;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>160</x>
            <y>1390</y>
            <w>520</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=1</panel_attributes>
        <additional_attributes>0;0;520;0</additional_attributes>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>440</x>
            <y>1150</y>
            <w>420</w>
            <h>120</h>
        </coordinates>
        <panel_attributes>the thcaMessageReceiversOUT stores 
the ACK's with a relationship with 
the IN table.

The column thcaMessageReceiversOUT.MessageReceiversIN 
relates the outbound ACK messages with the inbound message.



bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>550</x>
            <y>1270</y>
            <w>0</w>
            <h>120</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;120;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>2150</x>
            <y>1590</y>
            <w>20</w>
            <h>20</h>
        </coordinates>
        <panel_attributes>1
fontsize=14</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>2250</x>
            <y>1560</y>
            <w>20</w>
            <h>20</h>
        </coordinates>
        <panel_attributes>2
fontsize=14</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>1780</x>
            <y>1110</y>
            <w>640</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>The "UpdateReceiversINinOUT" method is called in the "ReaderDaemon" 
only for HL7 messages.
For WS messages is called inmediatly after leaving the message 
asynchronously to the "ReaderDaemon".

Read the "recipe" 
halign=left
fontsize=18
bg=green</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>320</x>
            <y>2450</y>
            <w>160</w>
            <h>150</h>
        </coordinates>
        <panel_attributes>*thcaACK
--
ID
ACKType
MessageControlID
MessageReceiversIN
MessageReceiversOUT
SampleId
rhcaHost
TS_TSDateTime
TS_TSUser
--
transparency=0
fontsize=10
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>480</x>
            <y>2400</y>
            <w>230</w>
            <h>130</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=*</panel_attributes>
        <additional_attributes>230;0;230;130;0;130</additional_attributes>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>170</x>
            <y>2420</y>
            <w>100</w>
            <h>80</h>
        </coordinates>
        <panel_attributes>ACKType:

  1 =&gt; AC
  2 =&gt; AA




bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>260</x>
            <y>2640</y>
            <w>460</w>
            <h>110</h>
        </coordinates>
        <panel_attributes>the "thcaACK" table stores the ControlID value of the sent 
messages, that are currently pending to be acknowledged 
by the instruments..

When a message is acknowledged, the entry for this message 
is removed.



bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>270</x>
            <y>2470</y>
            <w>50</w>
            <h>20</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>50;20;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>400</x>
            <y>2600</y>
            <w>0</w>
            <h>40</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;0;0;40</additional_attributes>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>1820</x>
            <y>2090</y>
            <w>590</w>
            <h>170</h>
        </coordinates>
        <panel_attributes>SELECT * FROM SQLUser.thcaACK
+----+---------+--------------------------------------+--------------------+---------------------+----------+----------+----------------+-----------+
| ID | ACKType | MessageControlID                     | MessageReceiversIN | MessageReceiversOUT | SampleId | rhcaHost | TS_TSDateTime  | TS_TSUser | 
+----+---------+--------------------------------------+--------------------+---------------------+----------+----------+----------------+-----------+
| 1  | 2       | 0DEE8ACC-AFE5-45FC-A4F1-8957FD33C7B4 |                    | 2                   |          | 5        | 20221122083408 | SYS_HCA_5 | 
| 8  | 2       | 76B1242B-B25F-4682-AF73-64AE2B95503F |                    | 14                  |          | 5        | 20221122083416 | SYS_HCA_5 | 
| 14 | 2       | BFA900D2-5D27-4604-BE40-37815C28DAE9 |                    | 31                  |          | 5        | 20221122083418 | SYS_HCA_5 | 
| 37 | 2       | CFFBBD35-6CCD-4B5E-83F3-D66108A42EAC |                    | 77                  |          | 5        | 20221122083445 | SYS_HCA_5 | 
| 41 | 2       | 907A00C3-638E-4FBC-AF15-E2BD76DA028A |                    | 83                  |          | 5        | 20221122083448 | SYS_HCA_5 | 
| 43 | 2       | B42C05FD-430B-49E7-A9FF-EA61EE0CB199 |                    | 85                  |          | 5        | 20221122083449 | SYS_HCA_5 | 
| 48 | 2       | 5F6747A9-53B4-42C7-8763-507869030629 |                    | 91                  |          | 5        | 20221122083452 | SYS_HCA_5 | 
+----+---------+--------------------------------------+--------------------+---------------------+----------+----------+----------------+-----------+
7 row(s).


bg=yellow
fontsize=10
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>50</x>
            <y>2520</y>
            <w>220</w>
            <h>50</h>
        </coordinates>
        <panel_attributes>column "MessageReceiversIN"
is never used



bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>270</x>
            <y>2510</y>
            <w>50</w>
            <h>30</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>50;0;0;30</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>910</x>
            <y>2470</y>
            <w>520</w>
            <h>240</h>
        </coordinates>
        <panel_attributes>*hca.chcaACK*
--
--
InsertACKData(
   pstrProcess As %String, 
   pintACKType As %Integer, 
   pstrMessageControlID As %String, 
   pintReceiversIDOUT As %Integer, 
   pobjTraceInfo As dt.hcaTraceInfo)
   
UpdateInfoACKReceived(
   pstrProcess As %String, 
   pobjmsgLIS As msg.LIS, 
   pobjTraceInfo As dt.hcaTraceInfo)
--
fontsize=14
bg=orange</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>1040</x>
            <y>2220</y>
            <w>460</w>
            <h>170</h>
        </coordinates>
        <panel_attributes>*Interesting methods:*

*InsertACKData() *
     - Called when a message is sent: creates new entries in the table 
       "thcaACK" for the pending ACKs (can create a pending AC + AA)

*UpdateInfoACKReceived() *
     - Called when an ACK is received, updates the messaging tables
     with this confirmation, status, error message, ...

bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>1280</x>
            <y>2390</y>
            <w>0</w>
            <h>80</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;0;0;80</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>1130</x>
            <y>1420</y>
            <w>520</w>
            <h>130</h>
        </coordinates>
        <panel_attributes>*hca.mhl.cMessageHandlerManager*
--
--
UpdateReceiversINinOUT(
   pintReceiversOUT As %Integer, 
   pintReceiversIN As %Integer, 
   pstrTraceMode As %String, 
   pobjTraceInfo As dt.hcaTraceInfo) As %Status
--
fontsize=14
bg=orange</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>1130</x>
            <y>1250</y>
            <w>520</w>
            <h>100</h>
        </coordinates>
        <panel_attributes>*Interesting methods:*

*UpdateReceiversINinOUT() *
     - Relates the sent ACK with the original message
       (User.thcaMessageReceiversOUT#MessageReceiversIN)

     
bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>1400</x>
            <y>1350</y>
            <w>0</w>
            <h>70</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;0;0;70</additional_attributes>
    </element>
    <element>
        <id>UMLNote</id>
        <coordinates>
            <x>910</x>
            <y>2250</y>
            <w>110</w>
            <h>90</h>
        </coordinates>
        <panel_attributes>pintACKType:

1 =&gt; AC
2 =&gt; AA
3 =&gt; AC+AA



bg=yellow
fontsize=14
transparency=0
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>960</x>
            <y>2340</y>
            <w>0</w>
            <h>130</h>
        </coordinates>
        <panel_attributes>lt=.</panel_attributes>
        <additional_attributes>0;130;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>180</x>
            <y>2260</y>
            <w>460</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;&lt;&lt;&lt;&lt;-
m2=1
layer=2</panel_attributes>
        <additional_attributes>0;0;460;0</additional_attributes>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>40</x>
            <y>2160</y>
            <w>140</w>
            <h>230</h>
        </coordinates>
        <panel_attributes>*thcaMessageReceiversIN
--
AppACKSend
ComACKSend
CreationDate
LstID
MessageControlID
MessageType
Opened
Priority
ProcessNum
SampleID
Sender
SenderID
WSComAnswer
rMessageObject
rMessageQueue
--

transparency=0
fontsize=10
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLClass</id>
        <coordinates>
            <x>640</x>
            <y>2170</y>
            <w>150</w>
            <h>230</h>
        </coordinates>
        <panel_attributes>*thcaMessageReceiversOUT
--
ID
AppACKReceived
ComACKReceived
CreationDate
ErrorProcessing
MessageReceiversIN
MessageType
Opened
Priority
SampleID
Sender
SenderID
rMessageObject
rMessageQueue
TS_TSDateTime
TS_TSUser
--
transparency=0
fontsize=10
layer=1</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>50</x>
            <y>460</y>
            <w>240</w>
            <h>250</h>
        </coordinates>
        <panel_attributes>  Outbound ACKs

valign=top
halign=left
fontsize=28
</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>180</x>
            <y>540</y>
            <w>70</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>.VC
halign=center
fontsize=18
bg=green</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>80</x>
            <y>640</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
ACK</panel_attributes>
        <additional_attributes>0;0;100;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>80</x>
            <y>570</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
Message</panel_attributes>
        <additional_attributes>100;0;0;0</additional_attributes>
    </element>
    <element>
        <id>UMLState</id>
        <coordinates>
            <x>450</x>
            <y>540</y>
            <w>70</w>
            <h>140</h>
        </coordinates>
        <panel_attributes>.VC
halign=center
fontsize=18
bg=green</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>520</x>
            <y>570</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
Message
</panel_attributes>
        <additional_attributes>100;0;0;0</additional_attributes>
    </element>
    <element>
        <id>Relation</id>
        <coordinates>
            <x>520</x>
            <y>640</y>
            <w>100</w>
            <h>0</h>
        </coordinates>
        <panel_attributes>lt=&lt;-
ACK</panel_attributes>
        <additional_attributes>0;0;100;0</additional_attributes>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>0</x>
            <y>460</y>
            <w>40</w>
            <h>40</h>
        </coordinates>
        <panel_attributes>A
fontsize=30</panel_attributes>
        <additional_attributes/>
    </element>
    <element>
        <id>UMLUseCase</id>
        <coordinates>
            <x>360</x>
            <y>460</y>
            <w>40</w>
            <h>40</h>
        </coordinates>
        <panel_attributes>B
fontsize=30</panel_attributes>
        <additional_attributes/>
    </element>
</diagram>
